{% load static %}
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrar â€” Bora Ã s compras!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #111;
            color: #ccc;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 32px 28px;
            width: 100%;
            max-width: 380px;
        }
        .auth-card h1 {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 8px;
        }
        .auth-card .subtitle {
            text-align: center;
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 24px;
        }
        .auth-card input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #333;
            border-radius: 10px;
            background-color: #222;
            color: #ccc;
            font-size: 1.05rem;
            margin-bottom: 12px;
            outline: none;
        }
        .auth-card input:focus { border-color: #555; }
        .auth-card .btn-primary {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background-color: #e0e0e0;
            color: #111;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 4px;
            transition: background-color 0.2s;
        }
        .auth-card .btn-primary:active { background-color: #bbb; }
        .auth-card .link {
            display: block;
            text-align: center;
            margin-top: 16px;
            color: #888;
            font-size: 0.95rem;
        }
        .auth-card .link a {
            color: #ccc;
            text-decoration: underline;
        }
        .erro {
            background: #3a1c1c;
            color: #f88;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 14px;
            font-size: 0.95rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="auth-card">
        <h1>ðŸ›’ Entrar</h1>
        <p class="subtitle">Bora Ã s compras!</p>
        {% if erro %}<div class="erro">{{ erro }}</div>{% endif %}
        <div class="erro" id="jsErro" style="display:none;"></div>
        <form method="POST" id="loginForm">
            {% csrf_token %}
            {% if next %}<input type="hidden" name="next" value="{{ next }}">{% endif %}
            <input type="text" name="username" placeholder="Nome de utilizador" required autocomplete="username">
            <input type="password" id="password" placeholder="Palavra-passe" required autocomplete="current-password">
            <input type="hidden" name="password_hash" id="password_hash">
            <button type="submit" class="btn-primary">Entrar</button>
        </form>
        <p class="link">NÃ£o tem conta? <a href="{% url 'registar' %}{% if next %}?next={{ next }}{% endif %}">Registar</a></p>
    </div>
    <script>
        /*
         * Hashing da palavra-passe no browser (o servidor NUNCA recebe a password em texto).
         *
         * MÃ©todo principal : crypto.subtle.digest (SHA-256 nativo do browser)
         *   â†’ Requer contexto seguro (HTTPS ou localhost).
         *   â†’ Quando tiveres domÃ­nio, basta configurar HTTPS (ver Caddyfile)
         *     e este mÃ©todo serÃ¡ usado automaticamente.
         *
         * Fallback : implementaÃ§Ã£o SHA-256 em JS puro
         *   â†’ Usado quando crypto.subtle nÃ£o estÃ¡ disponÃ­vel (HTTP sem localhost).
         */

        /* â”€â”€ SHA-256 nativo (crypto.subtle) â”€â”€ */
        function sha256Native(str) {
            var encoder = new TextEncoder();
            var data = encoder.encode(str);
            return crypto.subtle.digest('SHA-256', data).then(function(buffer) {
                var hashArray = Array.from(new Uint8Array(buffer));
                return hashArray.map(function(b) { return ('00' + b.toString(16)).slice(-2); }).join('');
            });
        }

        /* â”€â”€ SHA-256 fallback (JS puro, para contextos nÃ£o-HTTPS) â”€â”€ */
        function sha256Fallback(str) {
            function rightRotate(value, amount) { return (value >>> amount) | (value << (32 - amount)); }
            var mathPow = Math.pow, maxWord = mathPow(2, 32);
            var lengthProperty = 'length', i, j;
            var result = '';
            var words = [];
            var asciiBitLength = str[lengthProperty] * 8;
            var hash = [];
            var k = [];
            var primeCounter = 0;
            var isComposite = {};
            for (var candidate = 2; primeCounter < 64; candidate++) {
                if (!isComposite[candidate]) {
                    for (i = 0; i < 313; i += candidate) { isComposite[i] = candidate; }
                    hash[primeCounter] = (mathPow(candidate, .5) * maxWord) | 0;
                    k[primeCounter++] = (mathPow(candidate, 1 / 3) * maxWord) | 0;
                }
            }
            str += '\x80';
            while (str[lengthProperty] % 64 - 56) str += '\x00';
            for (i = 0; i < str[lengthProperty]; i++) {
                j = str.charCodeAt(i);
                if (j >> 8) return;
                words[i >> 2] |= j << ((3 - i) % 4) * 8;
            }
            words[words[lengthProperty]] = ((asciiBitLength / maxWord) | 0);
            words[words[lengthProperty]] = (asciiBitLength);
            for (j = 0; j < words[lengthProperty];) {
                var w = words.slice(j, j += 16);
                var oldHash = hash;
                hash = hash.slice(0, 8);
                for (i = 0; i < 64; i++) {
                    var w15 = w[i - 15], w2 = w[i - 2];
                    var a = hash[0], e = hash[4];
                    var temp1 = hash[7]
                        + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25))
                        + ((e & hash[5]) ^ ((~e) & hash[6]))
                        + k[i]
                        + (w[i] = (i < 16) ? w[i] : (
                            w[i - 16]
                            + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15 >>> 3))
                            + w[i - 7]
                            + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2 >>> 10))
                        ) | 0);
                    var temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22))
                        + ((a & hash[1]) ^ (a & hash[2]) ^ (hash[1] & hash[2]));
                    hash = [(temp1 + temp2) | 0].concat(hash);
                    hash[4] = (hash[4] + temp1) | 0;
                }
                for (i = 0; i < 8; i++) { hash[i] = (hash[i] + oldHash[i]) | 0; }
            }
            for (i = 0; i < 8; i++) {
                for (j = 3; j + 1; j--) {
                    var b = (hash[i] >> (j * 8)) & 255;
                    result += ((b < 16) ? '0' : '') + b.toString(16);
                }
            }
            return result;
        }

        /* â”€â”€ Escolhe o mÃ©todo disponÃ­vel â”€â”€ */
        function hashPassword(pw) {
            if (window.crypto && crypto.subtle) {
                return sha256Native(pw);
            }
            return Promise.resolve(sha256Fallback(pw));
        }

        function showJsError(msg) {
            var el = document.getElementById('jsErro');
            el.textContent = msg;
            el.style.display = 'block';
        }

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var form = this;
            var pw = document.getElementById('password').value;
            if (!pw) { showJsError('Introduza uma palavra-passe.'); return; }
            hashPassword(pw).then(function(hashHex) {
                if (!hashHex) { showJsError('Erro ao processar a palavra-passe.'); return; }
                document.getElementById('password_hash').value = hashHex;
                document.getElementById('password').value = '';
                form.submit();
            }).catch(function(err) {
                showJsError('Erro: ' + err.message);
            });
        });
    </script>
</body>
</html>
